name: Deploy to EC2 (Self-contained)
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v3
      
      # 2. JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # 3. gradlew 실행 권한 추가
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      
      # 4. Gradle로 프로젝트 빌드
      - name: Build with Gradle
        run: ./gradlew build -x test
      
      # 5. 빌드된 JAR 파일을 EC2로 전송
      - name: Transfer JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.SSH_USER }}/app"
          strip_components: 2
      
      # 6. 배포 스크립트 생성 및 실행
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY
          command_timeout: 15m
          script: |
            # 배포 스크립트를 파일로 생성
            cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT_EOF'
            #!/bin/bash
            
            # AWS 환경변수 설정 (부모 프로세스에서 전달받음)
            export AWS_ACCESS_KEY_ID="$1"
            export AWS_SECRET_ACCESS_KEY="$2"
            export SSH_USER="$3"
            
            # --------------------------------------------------
            # AWS Secrets Manager 설정
            # --------------------------------------------------
            SECRET_NAME="security"
            AWS_REGION="ap-northeast-2"
            
            echo "> Secrets Manager에서 환경변수를 가져옵니다."
            SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id $SECRET_NAME --region $AWS_REGION --query SecretString --output text)
            
            # 환경변수를 파일로 저장 후 source
            echo "$SECRET_JSON" | jq -r 'to_entries | map({key: .key | ascii_upcase | gsub("\\."; "_"), value: .value}) | map(.key + "=\"" + (.value | tostring) + "\"") | .[]' > /tmp/env_vars.sh
            source /tmp/env_vars.sh
            rm /tmp/env_vars.sh
            echo "> 환경변수 로딩 완료."
            
            # 애플리케이션 디렉토리 설정
            APP_DIR="/home/${SSH_USER}/app"
            
            # 기존 애플리케이션 종료
            echo "> 기존 애플리케이션 확인 중..."
            CURRENT_PID=$(pgrep -f "java.*\.jar")
            
            if [ -n "$CURRENT_PID" ]; then
              echo "> 실행 중인 애플리케이션을 종료합니다. (PID: $CURRENT_PID)"
              kill -15 $CURRENT_PID
              
              # 프로세스가 종료될 때까지 대기 (최대 30초)
              for i in {1..30}; do
                if ! ps -p $CURRENT_PID > /dev/null 2>&1; then
                  echo "> 애플리케이션이 정상 종료되었습니다."
                  break
                fi
                echo "> 종료 대기 중... ($i/30)"
                sleep 1
              done
              
              # 여전히 실행 중이면 강제 종료
              if ps -p $CURRENT_PID > /dev/null 2>&1; then
                echo "> 강제 종료합니다."
                kill -9 $CURRENT_PID
                sleep 2
              fi
            else
              echo "> 현재 실행 중인 애플리케이션이 없습니다."
            fi
            
            # 새 애플리케이션 실행
            JAR_NAME=$(ls -tr $APP_DIR/*.jar 2>/dev/null | tail -n 1)
            
            if [ -z "$JAR_NAME" ]; then
              echo "> ERROR: JAR 파일을 찾을 수 없습니다."
              exit 1
            fi
            
            echo "> 새 애플리케이션을 배포합니다: $JAR_NAME"
            
            # nohup으로 백그라운드 실행
            nohup java -jar -Dspring.profiles.active=prod "$JAR_NAME" > "$APP_DIR/application.log" 2>&1 < /dev/null &
            NEW_PID=$!
            
            # 프로세스 시작 확인
            sleep 3
            if ps -p $NEW_PID > /dev/null 2>&1; then
              echo "> 애플리케이션이 성공적으로 시작되었습니다. (PID: $NEW_PID)"
              echo "$NEW_PID" > "$APP_DIR/app.pid"
            else
              echo "> ERROR: 애플리케이션 시작에 실패했습니다."
              echo "> 로그 확인: tail -50 $APP_DIR/application.log"
              exit 1
            fi
            
            echo "> 배포 완료!"
            DEPLOY_SCRIPT_EOF
            
            # 스크립트 실행 권한 부여
            chmod +x /tmp/deploy.sh
            
            # 백그라운드에서 배포 스크립트 실행 (SSH 세션과 분리)
            echo "> 배포 스크립트를 백그라운드에서 실행합니다..."
            nohup /tmp/deploy.sh "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY" "${{ secrets.SSH_USER }}" > /tmp/deploy.log 2>&1 &
            
            echo "> 배포 스크립트가 시작되었습니다."
            echo "> 배포 로그 확인: tail -f /tmp/deploy.log"
            
            # 배포 스크립트가 시작될 시간을 준 후 SSH 종료
            sleep 2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
