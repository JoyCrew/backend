name: Deploy to EC2 (Self-contained)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. gradlew ì‹¤í–‰ ê¶Œí•œ ì¶”ê°€
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradleë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew build -x test

      # 5. ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ì „ì†¡ (Secret ì´ë¦„ì„ SSH_HOST/USER/KEYë¡œ ë³€ê²½)
      - name: Transfer JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}        # SSH_HOST ì‚¬ìš©
          username: ${{ secrets.SSH_USER }}    # SSH_USER ì‚¬ìš©
          key: ${{ secrets.SSH_KEY }}          # SSH_KEY ì‚¬ìš©
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.SSH_USER }}" # ëŒ€ìƒ ê²½ë¡œ ìˆ˜ì •

      # 6. EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ëª…ë ¹ ì‹¤í–‰ (Secret ì´ë¦„ ë° AWS ì¸ì¦ ì£¼ìž…)
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}        # SSH_HOST ì‚¬ìš©
          username: ${{ secrets.SSH_USER }}    # SSH_USER ì‚¬ìš©
          key: ${{ secrets.SSH_KEY }}          # SSH_KEY ì‚¬ìš©
          
          # AWS CLI ì‚¬ìš©ì„ ìœ„í•´ ì¸ì¦ ì •ë³´ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ìž…í•©ë‹ˆë‹¤.
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          script: |
            # --------------------------------------------------
            # AWS Secrets Manager ì„¤ì •
            # --------------------------------------------------
            SECRET_NAME="security"  # ðŸ‘ˆ Secrets Manager ì´ë¦„ "security"ë¡œ í™•ì •
            AWS_REGION="ap-northeast-2" # ðŸ‘ˆ ARNì— ë”°ë¥¸ ë¦¬ì „ í™•ì •

            # --------------------------------------------------
            # ë°°í¬ ë¡œì§ ì‹œìž‘
            # --------------------------------------------------
            echo "> Secrets Managerì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."
            # env ë¸”ë¡ì„ í†µí•´ ì£¼ìž…ëœ AWS_ACCESS_KEY_IDì™€ AWS_SECRET_ACCESS_KEYë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ë¨
            SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id $SECRET_NAME --region $AWS_REGION --query SecretString --output text)
            
            # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSONì˜ ê° í‚¤-ê°’ì„ 'export KEY="VALUE"' í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ê³  ì‹¤í–‰
            export $(echo $SECRET_JSON | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]')
            echo "> í™˜ê²½ë³€ìˆ˜ ë¡œë”© ì™„ë£Œ."

            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
            CURRENT_PID=$(pgrep -f ".jar")
            if [ -z "$CURRENT_PID" ]; then
              echo "> í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            else
              echo "> ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. (PID: $CURRENT_PID)"
              kill -15 $CURRENT_PID
              sleep 5
            fi

            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            EC2_HOME="/home/${{ secrets.SSH_USER }}" # ðŸ‘ˆ SSH_USER Secret ì‚¬ìš©
            JAR_NAME=$(ls -tr $EC2_HOME/*.jar | tail -n 1)
            echo "> ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•©ë‹ˆë‹¤: $JAR_NAME"
            
            # nohupì„ ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            nohup java -jar -Dspring.profiles.active=prod $JAR_NAME > $EC2_HOME/application.log 2>&1 &